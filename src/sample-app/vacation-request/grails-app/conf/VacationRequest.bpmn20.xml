<?xml version="1.0" encoding="UTF-8" ?>

<definitions id="definitions"
             targetNamespace="http://activiti.org/bpmn20" 
             xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:activiti="http://activiti.org/bpmn">
  
  <process id="vacationRequest" name="Vacation request">
  
    <startEvent id="request" />

    <sequenceFlow id="flow0" sourceRef="request" targetRef="create" />
    
    <userTask id="create" name="Initiate vacation request">
      <documentation>
        Vacation request by ${username}
      </documentation> 
      <potentialOwner>
        <resourceAssignmentExpression>
          <formalExpression>user</formalExpression>
        </resourceAssignmentExpression>
      </potentialOwner>         
    </userTask>
    
    <sequenceFlow id="flow1" sourceRef="create" targetRef="handleRequest" />
    
    <userTask id="handleRequest" name="Handle vacation request"
              activiti:formKey="/vacationRequest/approval" >
      <documentation>
        Vacation request by ${username}
      </documentation> 
      <potentialOwner>
        <resourceAssignmentExpression>
          <formalExpression>management</formalExpression>
        </resourceAssignmentExpression>
      </potentialOwner>         
    </userTask>

    <sequenceFlow id='flow2' sourceRef='handleRequest' targetRef='requestApprovedDecision' />
    
    <exclusiveGateway id="requestApprovedDecision" name="Request approved?" />
    
    <sequenceFlow id='flow3' sourceRef="requestApprovedDecision" targetRef="sendApprovalMail">
      <conditionExpression xsi:type="tFormalExpression">${vacationApproved}</conditionExpression>
    </sequenceFlow>
    
    <serviceTask id="sendApprovalMail" name="Send approval e-mail" activiti:class="vacationRequest.MailSender" />  
    
    <sequenceFlow id='flow4' sourceRef="sendApprovalMail" targetRef="theEnd1" />
    
    <endEvent id="theEnd1" />
    
    <sequenceFlow id='flow5' sourceRef="requestApprovedDecision" targetRef="adjustVacationRequestTask">
      <conditionExpression xsi:type="tFormalExpression">${!vacationApproved}</conditionExpression>
    </sequenceFlow>
    
    <userTask id="adjustVacationRequestTask" name="Adjust vacation request" 
              activiti:formKey="/vacationRequest/edit">
      <documentation>
        Your manager has not approved your vacation request.
      </documentation>
      <humanPerformer>
        <resourceAssignmentExpression>
          <formalExpression>${username}</formalExpression>
        </resourceAssignmentExpression>
      </humanPerformer>  
    </userTask>
     
    <sequenceFlow id='flow6' sourceRef="adjustVacationRequestTask" targetRef="resendRequestDecision" />
    
    <exclusiveGateway id="resendRequestDecision" name="Resend request?" />
    
    <sequenceFlow id='flow7' sourceRef="resendRequestDecision" targetRef="handleRequest">
      <conditionExpression xsi:type="tFormalExpression">${resendRequest}</conditionExpression>
    </sequenceFlow>
    
     <sequenceFlow id='flow8' sourceRef="resendRequestDecision" targetRef="theEnd2">
      <conditionExpression xsi:type="tFormalExpression">${!resendRequest}</conditionExpression>
    </sequenceFlow>
          
    <endEvent id="theEnd2" />
      
  </process>
  
</definitions>
